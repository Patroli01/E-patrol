<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Patrol Security Pro QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #reader { border-radius: 12px; overflow: hidden; border: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-6 px-4">

    <div class="w-full max-w-md bg-blue-900 text-white p-5 rounded-2xl shadow-lg mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold">E-Patrol QR</h1>
            <p class="text-blue-200 text-xs">Instan & Cepat</p>
        </div>
        <i class="fas fa-qrcode text-3xl text-blue-300"></i>
    </div>

    <div class="w-full max-w-md bg-white rounded-2xl shadow-md p-6">
        <form id="patrolForm" onsubmit="handleFormSubmit(event)">
            
            <!-- Nama Petugas -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2 flex justify-between">
                    <span>Nama Petugas</span>
                    <span id="syncStatus" class="text-[10px] text-green-600 font-normal">Memuat...</span>
                </label>
                <select id="nama" class="w-full px-3 py-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Pilih Nama...</option>
                </select>
            </div>

            <!-- Lokasi dengan Scan QR -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2 flex justify-between">
                    <span>Lokasi / Titik</span>
                    <button type="button" onclick="toggleScanner()" class="text-blue-600 text-xs font-bold uppercase"><i class="fas fa-expand mr-1"></i>Scan QR</button>
                </label>
                
                <div id="scanner-container" class="hidden mb-3">
                    <div id="reader"></div>
                    <button type="button" onclick="toggleScanner()" class="w-full bg-red-100 text-red-600 text-xs py-2 mt-2 rounded-lg">Batal Scan</button>
                </div>

                <input type="text" id="lokasi" placeholder="Scan QR atau ketik lokasi..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan Situasi</label>
                <textarea id="keterangan" rows="2" placeholder="Tulis kondisi keamanan..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Foto Dokumentasi</label>
                <input type="file" id="fotoInput" accept="image/*" capture="environment" class="hidden" multiple onchange="handleFiles(this.files)">
                <div id="photoGallery" class="grid grid-cols-3 gap-2 mb-3">
                    <div onclick="document.getElementById('fotoInput').click()" class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center bg-gray-50 active:bg-gray-100 cursor-pointer">
                        <i class="fas fa-camera text-gray-400 text-xl"></i>
                        <span class="text-[10px] text-gray-400 mt-1">Foto</span>
                    </div>
                </div>
                <p id="photoCount" class="text-xs text-gray-500 text-center">Minimal 1 foto</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transform active:scale-95 transition">
                <span id="btnText">Kirim Laporan</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-xs text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-2xl text-green-600"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 text-gray-800">Terkirim!</h2>
            <p class="text-gray-500 text-sm mb-6">Laporan berhasil dikirim ke grup WA.</p>
            <button onclick="location.reload()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl">Lanjutkan</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxlKHwB5j0lADBG3w2aQI4zzinxMR_jsm6eokR3QMcyNsd8bqYlnUYFEe10JPpsGhW1/exec"; 
        
        // DAFTAR NAMA CADANGAN (Hardcode) agar aplikasi langsung siap pakai
        const NAMA_BACKUP = ["Petugas 1", "Petugas 2", "Petugas 3", "Petugas 4"];
        
        const MAP_LOKASI = {
            "https://myqrcode.mobi/cbf8cde2": "Gerbang Utama Perusahaan"
        };

        let imageList = [];
        let html5QrCode;

        // Fungsi Memuat Nama (Instan)
        async function initApp() {
            const selectNama = document.getElementById('nama');
            const syncStatus = document.getElementById('syncStatus');

            // 1. Coba ambil dari LocalStorage dulu (Sangat Cepat)
            const cachedNames = localStorage.getItem('master_petugas');
            if (cachedNames) {
                renderNames(JSON.parse(cachedNames));
                syncStatus.textContent = "Data Lokal (Update...)";
            } else {
                // Jika kosong, gunakan backup agar petugas tidak menunggu
                renderNames(NAMA_BACKUP);
                syncStatus.textContent = "Data Dasar (Update...)";
            }

            // 2. Ambil dari server di latar belakang (Background Sync)
            try {
                const response = await fetch(SCRIPT_URL);
                const names = await response.json();
                if (Array.isArray(names) && names.length > 0) {
                    localStorage.setItem('master_petugas', JSON.stringify(names));
                    renderNames(names);
                    syncStatus.textContent = "Sinkron";
                }
            } catch (e) {
                syncStatus.textContent = "Offline";
                console.log("Gagal sinkron, menggunakan data terakhir.");
            }
        }

        function renderNames(names) {
            const selectNama = document.getElementById('nama');
            const currentVal = selectNama.value;
            selectNama.innerHTML = '<option value="" disabled selected>Pilih Nama...</option>';
            names.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                selectNama.appendChild(opt);
            });
            if (currentVal) selectNama.value = currentVal;
        }

        window.onload = initApp;

        // --- SCANNER, IMAGE, & SUBMIT LOGIC (Sama seperti sebelumnya) ---

        function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                    document.getElementById('lokasi').value = MAP_LOKASI[decodedText] || decodedText;
                    stopScanner();
                }).catch(err => console.error(err));
            } else { stopScanner(); }
        }

        function stopScanner() {
            if (html5QrCode) html5QrCode.stop().then(() => document.getElementById('scanner-container').classList.add('hidden'));
        }

        async function handleFiles(files) {
            for (let file of files) {
                const base64 = await convertToBase64(file);
                imageList.push(base64);
            }
            renderGallery();
        }

        function convertToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 800) { h = h * (800 / w); w = 800; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function renderGallery() {
            const gallery = document.getElementById('photoGallery');
            const addBtn = gallery.firstElementChild;
            gallery.innerHTML = '';
            gallery.appendChild(addBtn);
            imageList.forEach((imgData, index) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-lg overflow-hidden border border-gray-200';
                div.innerHTML = `<img src="${imgData}" class="w-full h-full object-cover"><button type="button" onclick="removeImage(${index})" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-[10px] rounded-bl-lg">Ã—</button>`;
                gallery.appendChild(div);
            });
            document.getElementById('photoCount').textContent = `${imageList.length} foto`;
        }

        function removeImage(index) { imageList.splice(index, 1); renderGallery(); }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (imageList.length === 0) return alert("Wajib foto!");
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            document.getElementById('btnLoader').classList.remove('hidden');

            const payload = {
                nama: document.getElementById('nama').value,
                lokasi: document.getElementById('lokasi').value,
                keterangan: document.getElementById('keterangan').value,
                images: imageList
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('successModal').classList.remove('hidden');
            } catch (err) {
                alert("Gagal kirim. Cek sinyal.");
                btn.disabled = false;
                document.getElementById('btnLoader').classList.add('hidden');
            }
        }
    </script>
</body>
</html>

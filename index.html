<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Patrol Security Pro QR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1e3a8a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .img-container:hover .delete-btn { display: flex; }
        #reader { border-radius: 12px; overflow: hidden; border: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-6 px-4">

    <div class="w-full max-w-md bg-blue-900 text-white p-5 rounded-2xl shadow-lg mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold">E-Patrol QR</h1>
            <p class="text-blue-200 text-xs">Master Data & QR Scanner</p>
        </div>
        <i class="fas fa-qrcode text-3xl text-blue-300"></i>
    </div>

    <div class="w-full max-w-md bg-white rounded-2xl shadow-md p-6">
        <form id="patrolForm" onsubmit="handleFormSubmit(event)">
            
            <!-- Nama Petugas dari Master Data -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Nama Petugas</label>
                <select id="nama" class="w-full px-3 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500" required>
                    <option value="" disabled selected>Memuat daftar nama...</option>
                </select>
            </div>

            <!-- Lokasi dengan Scan QR -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2 flex justify-between">
                    <span>Lokasi / Titik</span>
                    <button type="button" onclick="toggleScanner()" class="text-blue-600 text-xs font-bold uppercase"><i class="fas fa-expand mr-1"></i>Scan QR</button>
                </label>
                
                <!-- Scanner Area -->
                <div id="scanner-container" class="hidden mb-3">
                    <div id="reader"></div>
                    <button type="button" onclick="toggleScanner()" class="w-full bg-red-100 text-red-600 text-xs py-2 mt-2 rounded-lg">Batal Scan</button>
                </div>

                <input type="text" id="lokasi" placeholder="Ketik atau scan QR lokasi..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Keterangan Situasi</label>
                <textarea id="keterangan" rows="2" placeholder="Tulis kondisi keamanan..." class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></textarea>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Foto Dokumentasi</label>
                <input type="file" id="fotoInput" accept="image/*" capture="environment" class="hidden" multiple onchange="handleFiles(this.files)">
                <div id="photoGallery" class="grid grid-cols-3 gap-2 mb-3">
                    <div onclick="document.getElementById('fotoInput').click()" class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center bg-gray-50 active:bg-gray-100 cursor-pointer">
                        <i class="fas fa-camera text-gray-400 text-xl"></i>
                        <span class="text-[10px] text-gray-400 mt-1">Foto</span>
                    </div>
                </div>
                <p id="photoCount" class="text-xs text-gray-500 text-center">Minimal 1 foto</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-blue-900 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transform active:scale-95 transition">
                <span id="btnText">Kirim Laporan</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </form>
    </div>

    <!-- Modal Success -->
    <div id="successModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-xs text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-2xl text-green-600"></i>
            </div>
            <h2 class="text-xl font-bold mb-2 text-gray-800">Terkirim!</h2>
            <p class="text-gray-500 text-sm mb-6">Laporan patroli telah berhasil disimpan.</p>
            <button onclick="location.reload()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl">Lanjutkan</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQpGl6PC5JS67m3TjMOz5RFKHHpTi80a4yg6aXXu8JZp8Vmbw6qv1dSRGoQB3txKC3/exec"; 
        let imageList = [];
        let html5QrCode;

        // Load Master Data Nama on Start
        window.onload = async () => {
            const selectNama = document.getElementById('nama');
            try {
                const response = await fetch(SCRIPT_URL);
                const names = await response.json();
                selectNama.innerHTML = '<option value="" disabled selected>Pilih Nama...</option>';
                names.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    selectNama.appendChild(opt);
                });
            } catch (e) {
                selectNama.innerHTML = '<option value="" disabled selected>Gagal memuat nama</option>';
            }
        };

        // QR Scanner Logic
        function toggleScanner() {
            const container = document.getElementById('scanner-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        document.getElementById('lokasi').value = decodedText;
                        stopScanner();
                    },
                    (errorMessage) => {}
                ).catch(err => alert("Gagal akses kamera: " + err));
            } else {
                stopScanner();
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').classList.add('hidden');
                });
            }
        }

        // Image Logic
        async function handleFiles(files) {
            for (let file of files) {
                const base64 = await convertToBase64(file);
                imageList.push(base64);
            }
            renderGallery();
        }

        function convertToBase64(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 800) { h = h * (800 / w); w = 800; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function renderGallery() {
            const gallery = document.getElementById('photoGallery');
            const addBtn = gallery.firstElementChild;
            gallery.innerHTML = '';
            gallery.appendChild(addBtn);

            imageList.forEach((imgData, index) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-lg overflow-hidden border border-gray-200';
                div.innerHTML = `
                    <img src="${imgData}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeImage(${index})" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-[10px] rounded-bl-lg">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                gallery.appendChild(div);
            });
            document.getElementById('photoCount').textContent = `${imageList.length} foto dipilih`;
        }

        function removeImage(index) {
            imageList.splice(index, 1);
            renderGallery();
        }

        // Form Submit
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (imageList.length === 0) return alert("Ambil minimal 1 foto!");

            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            btn.disabled = true;
            btnText.textContent = "Mengirim...";
            btnLoader.classList.remove('hidden');

            const payload = {
                nama: document.getElementById('nama').value,
                lokasi: document.getElementById('lokasi').value,
                keterangan: document.getElementById('keterangan').value,
                images: imageList
            };

            try {
                // Post data ke Apps Script
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify(payload) 
                });
                document.getElementById('successModal').classList.remove('hidden');
            } catch (err) {
                alert("Gagal kirim. Pastikan internet stabil.");
                btn.disabled = false;
                btnText.textContent = "Kirim Laporan";
                btnLoader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
